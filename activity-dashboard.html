<!DOCTYPE html>
<html>
<head>
<title>JSON File Editor</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
  .timestamp {
    background-color: #f0f0f0;
  }
  .delete-btn {
    color: red;
    cursor: pointer;
    padding: 0 5px;
  }
</style>
</head>
<body>

<div class="container">
  <h1>JSON File Editor</h1>

  <div class="form-group">
    <label for="directoryPicker">Select Directory:</label>
    <input type="button" class="form-control-file" id="directoryPicker" value="Choose Directory">
  </div>

  <div id="fileControls" style="display: none;">
    <button class="btn btn-secondary" id="refreshFiles">Refresh</button>
    <button class="btn btn-primary" id="createNewFile">New JSON File</button>
  </div>

  <ul id="fileList" class="list-group mt-3"></ul>

  <div id="editor" class="mt-3" style="display: none;">
    <h2>Edit JSON File</h2>
    <table id="dataTable" class="table table-bordered">
      <thead></thead>
      <tbody></tbody>
    </table>
    <button class="btn btn-secondary" id="refreshFile">Refresh File</button>
    <button class="btn btn-primary" id="saveChanges">Save Changes</button>
    <button class="btn btn-success" id="addRow">Add Row</button>
  </div>
</div>

<script>
  let currentDirectoryHandle;

  document.getElementById('directoryPicker').addEventListener('click', async () => {
    if (localStorage.getItem('directoryHandle')) {
      try {
        currentDirectoryHandle = await window.showDirectoryPicker({
          id: localStorage.getItem('directoryHandle'),
          startIn: 'desktop'
        });
      } catch (error) {
        console.error('Error loading directory from localStorage:', error);
        localStorage.removeItem('directoryHandle');
        currentDirectoryHandle = await window.showDirectoryPicker({
          startIn: 'desktop'
        });
      }
    } else {
      currentDirectoryHandle = await window.showDirectoryPicker({
        startIn: 'desktop'
      });
    }

    localStorage.setItem('directoryHandle', currentDirectoryHandle.id);
    loadFiles();
  });

  document.getElementById('refreshFiles').addEventListener('click', loadFiles);

  document.getElementById('createNewFile').addEventListener('click', async () => {
    const fileName = prompt('Enter file name (without .json):');
    if (fileName) {
      try {
        const newFileHandle = await currentDirectoryHandle.getFileHandle(`${fileName}.json`, { create: true });
        await writeFile(newFileHandle, '[]');
        loadFiles();
      } catch (error) {
        console.error('Error creating file:', error);
        alert('Error creating file!');
      }
    }
  });

  async function loadFiles() {
    if (!currentDirectoryHandle) return;

    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';

    document.getElementById('fileControls').style.display = 'block';

    try {
      for await (const entry of currentDirectoryHandle.values()) {
        if (entry.kind === 'file' && entry.name.endsWith('.json')) {
          const listItem = document.createElement('li');
          listItem.classList.add('list-group-item');
          listItem.textContent = entry.name;
          listItem.addEventListener('click', () => loadFile(entry));
          fileList.appendChild(listItem);
        }
      }
    } catch (error) {
      console.error('Error reading directory:', error);
      alert('Error reading directory!');
    }
  }

  let currentFileHandle;
  async function loadFile(fileEntry) {
    currentFileHandle = fileEntry;
    document.getElementById('editor').style.display = 'block';
    await displayFileData();
  }

  document.getElementById('refreshFile').addEventListener('click', displayFileData);

  document.getElementById('saveChanges').addEventListener('click', async () => {
    const data = [];
    const headers = Array.from(document.querySelectorAll('#dataTable thead th'))
      .map(th => th.textContent)
      .filter(header => header !== 'Actions'); // Exclude the Actions column
    const tableRows = document.querySelectorAll('#dataTable tbody tr');
    
    tableRows.forEach(row => {
      const rowData = {};
      headers.forEach(header => {
        rowData[header] = "";
      });

      const cells = Array.from(row.cells);
      cells.forEach((cell, index) => {
        const header = headers[index];
        if (!header) return; // Skip the Actions column
        if (header === 'todos') {
          rowData[header] = cell.dataset.originalValue || '';
        } else if (header === 'timestamp') {
          rowData[header] = cell.dataset.originalValue || cell.textContent;
        } else {
          rowData[header] = cell.textContent;
        }
      });

      data.push(rowData);
    });

    try {
      await writeFile(currentFileHandle, JSON.stringify(data, null, 2));
      alert('Changes saved successfully!');
    } catch (error) {
      console.error('Error saving changes:', error);
      alert('Error saving changes!');
    }
  });

  function deleteRow(button) {
    if (confirm('Are you sure you want to delete this row?')) {
      const row = button.closest('tr');
      row.remove();
    }
  }

  document.getElementById('addRow').addEventListener('click', () => {
    const tableBody = document.querySelector('#dataTable tbody');
    const newRow = tableBody.insertRow();
    const headers = document.querySelectorAll('#dataTable thead th');
    
    headers.forEach(header => {
      const newCell = newRow.insertCell();
      if (header.textContent === 'Actions') {
        const deleteButton = document.createElement('span');
        deleteButton.innerHTML = '×';
        deleteButton.className = 'delete-btn';
        deleteButton.onclick = function() { deleteRow(this); };
        newCell.appendChild(deleteButton);
      } else if (header.textContent === 'timestamp') {
        const timestamp = new Date().toISOString();
        newCell.textContent = timestamp;
        newCell.contentEditable = false;
        newCell.classList.add('timestamp');
        newCell.dataset.originalValue = timestamp;
      } else {
        newCell.contentEditable = true;
      }
    });
  });

  async function writeFile(fileHandle, data) {
    const writable = await fileHandle.createWritable();
    await writable.write(data);
    await writable.close();
  }

  async function displayFileData() {
    try {
      const file = await currentFileHandle.getFile();
      const jsonData = JSON.parse(await file.text());

      const table = document.getElementById('dataTable');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';

      if (jsonData.length > 0) {
        const headerRow = thead.insertRow();
        Object.keys(jsonData[0]).forEach(key => {
          const th = document.createElement('th');
          th.textContent = key;
          headerRow.appendChild(th);
        });
        // Add Actions column header
        const actionsHeader = document.createElement('th');
        actionsHeader.textContent = 'Actions';
        headerRow.appendChild(actionsHeader);
      }

      jsonData.forEach(item => {
        const row = tbody.insertRow();
        Object.entries(item).forEach(([key, value]) => {
          const cell = row.insertCell();
          
          if (key === 'todos') {
            const todos = (value || '').split('\n');
            if (todos.length === 1 && todos[0] === "") {
              cell.textContent = "";
            } else {
              todos.forEach(todo => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = todo.startsWith('- [x] ');
                checkbox.addEventListener('change', () => {
                  const updatedTodos = Array.from(cell.querySelectorAll('input[type="checkbox"]'))
                    .map(cb => (cb.checked ? '- [x] ' : '- [ ] ') + cb.nextSibling.textContent)
                    .join('\n');
                  cell.dataset.originalValue = updatedTodos;
                });
                const label = document.createElement('span');
                label.textContent = todo.replace(/^- \[[ x]\] /, '');
                cell.appendChild(checkbox);
                cell.appendChild(label);
                cell.appendChild(document.createElement('br'));
              });
              cell.dataset.originalValue = value;
            }
          } else if (key === 'timestamp') {
            cell.classList.add('timestamp');
            cell.contentEditable = false;
            cell.textContent = value;
            cell.dataset.originalValue = value;
          } else if (typeof value === 'string') {
            cell.innerHTML = value.replace(/\n/g, '<br>');
          } else if (Array.isArray(value)) {
            cell.innerHTML = value.join('<br>');
          }

          if (key !== 'timestamp' && key !== 'todos') {
            cell.contentEditable = true;
          }
        });

        // Add delete button cell
        const deleteCell = row.insertCell();
        const deleteButton = document.createElement('span');
        deleteButton.innerHTML = '×';
        deleteButton.className = 'delete-btn';
        deleteButton.onclick = function() { deleteRow(this); };
        deleteCell.appendChild(deleteButton);
      });
    } catch (error) {
      console.error('Error reading file:', error);
      alert('Error reading file!');
    }
  }
</script>

</body>
</html>